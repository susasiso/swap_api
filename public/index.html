<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quick Swap · Wizard UI</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0c3cff; --bg2:#0930c7; --card:#fff; --line:#e9edf5; --ink:#0b0f1a; --muted:#6e7f9f;
  --blue:#2060ff; --blue-700:#1751e8; --err:#ff5e74; --ok:#16c784; --chip:#f3f6fd;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:'Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
  background:linear-gradient(140deg,var(--bg),var(--bg2));display:flex;justify-content:center;align-items:center;padding:20px}
.card{width:min(560px,100%);background:var(--card);border-radius:22px;padding:22px;box-shadow:0 18px 50px rgba(0,0,0,.16)}
.stepper{display:flex;gap:8px;align-items:center;color:#567;font-size:12px;margin-bottom:14px}
.chip{padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
h2{margin:0 0 14px 0;font-size:20px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{display:block;font-size:12px;color:#5a6a86;margin:8px 0 6px}
select,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#f9fbff;font-size:16px;outline:none}
select:focus,input:focus{border-color:#b7ccff;background:#fff}
.box{border:1px solid var(--line);background:#f7faff;border-radius:14px;padding:12px 14px;display:flex;align-items:center;gap:10px}
.muted{color:var(--muted);font-size:13px}
.hint{font-size:12px;color:#7d8fb2;margin-top:6px}
.btn{width:100%;padding:14px 16px;border-radius:12px;border:0;color:#fff;background:var(--blue);font-weight:800;cursor:pointer;margin-top:16px;font-size:16px}
.btn:hover{background:var(--blue-700)} .btn:disabled{opacity:.6;cursor:not-allowed}
.divider{height:1px;background:var(--line);margin:14px 0}
.kbd{font-family:ui-monospace,Consolas,monospace;font-size:13px;padding:2px 6px;background:#eef3ff;border:1px solid var(--line);border-radius:6px}
.addr{word-break:break-all;line-height:1.35}
.center{display:flex;justify-content:center;align-items:center}
.qr{width:120px;height:120px;border-radius:12px;overflow:hidden;background:#fff;border:1px solid var(--line)}
.r{display:none}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f2f7ff;border:1px solid var(--line);font-size:12px}
.badge.ok{background:#ecfff6;border-color:#d4f6e5;color:#077e52}
.badge.warn{background:#fff9e7;border-color:#ffe8a8;color:#7a5d07}
.error-box{margin-top:10px;background:#ffeff1;border:1px solid #ffd5db;color:#b41f35;padding:10px 12px;border-radius:10px;display:none}

.field-wrap{position:relative}
.err-ico{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;display:none}
input.invalid{border-color:var(--err);background:#fff6f7}
input.invalid ~ .err-ico{display:block}
@media (max-width:420px){ .row{grid-template-columns:1fr} .qr{width:104px;height:104px} }
</style>
</head>
<body>
<div class="card">

  <!-- STEP 1: details -->
  <section id="s1">
    <div class="stepper"><span class="chip">1/4</span><span class="muted">Add exchange details</span></div>
    <h2>Add exchange details</h2>

    <div class="row">
      <div>
        <label>Amount</label>
        <input id="amount" type="number" min="0" step="0.0001" value="50">
      </div>
      <div>
        <label>You send</label>
        <!-- value: SYMBOL:NETWORK -->
        <select id="from">
          <option value="USDT:TRON">USDT TRX</option>
          <option value="USDT:ETH">USDT ERC20</option>
          <option value="USDC:ETH">USDC ERC20</option>
          <option value="TRX:TRON">TRX</option>
          <option value="BTC:MAIN">BTC</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <div class="muted">Floating rate</div>
      <div style="text-align:right"><span class="muted">Rate type</span> <span class="badge">Floating</span></div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="muted">You get ≈ <span id="est">—</span></div>
      <div>
        <label>You get</label>
        <select id="to">
          <option value="TRX:TRON">TRX TRX</option>
          <option value="ETH:ETH">ETH ERC20</option>
          <option value="USDT:TRON">USDT TRX</option>
        </select>
      </div>
    </div>

    <button class="btn" id="next1">Exchange</button>
    <div class="error-box" id="e1"></div>
  </section>

  <!-- STEP 2: recipient/refund -->
  <section id="s2" class="r">
    <div class="stepper"><span class="chip">2/4</span><span class="muted">Recipient info</span></div>
    <h2>Recipient info</h2>

    <div class="box" id="pair">
      <span class="muted">You send</span><span class="kbd" id="sumSend"></span>
      <span class="muted" style="margin:0 6px">→</span>
      <span class="muted">You get</span><span class="kbd" id="sumGet"></span>
    </div>

    <label style="margin-top:12px" id="recvLabel">The recipient’s address</label>
    <div class="field-wrap">
      <input id="recv" placeholder="수취 주소(네트워크 일치)">
      <!-- 빨간 에러 아이콘 -->
      <svg class="err-ico" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#ff5e74" stroke-width="2"/><path d="M12 7v7" stroke="#ff5e74" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="17" r="1.6" fill="#ff5e74"/></svg>
    </div>

    <label style="margin-top:12px">Refund address (same network as “You send”)</label>
    <div class="field-wrap">
      <input id="refund" placeholder="리펀드 주소(From 네트워크)">
      <svg class="err-ico" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#ff5e74" stroke-width="2"/><path d="M12 7v7" stroke="#ff5e74" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="17" r="1.6" fill="#ff5e74"/></svg>
    </div>

    <button class="btn" id="next2">Create an exchange</button>
    <div class="error-box" id="e2"></div>
  </section>

  <!-- STEP 3: confirming -->
  <section id="s3" class="r">
    <div class="stepper"><span class="chip">3/4</span><span class="muted" id="s3state"><span class="badge">Pending deposit</span></span></div>
    <h2 id="s3title">Send your <span id="sendLabel">—</span></h2>

    <div class="row" style="align-items:center">
      <div class="center"><img id="qr" class="qr" alt="QR"></div>
      <div>
        <div class="muted">Deposit address:</div>
        <div id="depAddr" class="addr kbd" style="margin-top:6px"></div>
        <div class="muted" style="margin-top:8px">Hash in: <span id="hashIn" class="kbd">—</span></div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="muted">Exchange ID: <span id="exId" class="kbd"></span></div>
  </section>

  <!-- STEP 4: completed -->
  <section id="s4" class="r">
    <div class="stepper"><span class="chip">4/4</span><span class="muted">Completed</span></div>
    <h2 class="ok">Your exchange was completed</h2>

    <div class="box" style="margin-bottom:12px">
      <span class="muted">You send</span><span class="kbd" id="cSend"></span>
      <span class="muted" style="margin:0 6px">→</span>
      <span class="muted">You get</span><span class="kbd" id="cGet"></span>
    </div>

    <div class="muted" style="margin-top:6px">Recipient address: <span id="cRecv" class="kbd"></span></div>
    <div class="muted" style="margin-top:6px">Hash in: <span id="cIn" class="kbd"></span></div>
    <div class="muted" style="margin-top:6px">Hash out: <span id="cOut" class="kbd"></span></div>

    <button class="btn" id="restart">⟳ Create a new exchange</button>
    <div class="muted" style="margin-top:10px">Exchange ID: <span id="cId" class="kbd"></span></div>
  </section>

</div>

<script>
const $ = s => document.querySelector(s);
const API = {
  est: (from,to,amount)=>`/api/estimate?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&amount=${encodeURIComponent(amount)}&rateType=floating`,
  create:'/api/create-exchange',
  status:id=>`/api/status/${encodeURIComponent(id)}`
};
// 간단 주소 패턴(체인별)
const RE = {
  'TRON': /^T[1-9A-HJ-NP-Za-km-z]{33}$/,
  'ETH': /^0x[a-fA-F0-9]{40}$/,
  'BSC': /^0x[a-fA-F0-9]{40}$/,
  'MATIC': /^0x[a-fA-F0-9]{40}$/,
  'MAIN': /^(bc1|[13])[a-zA-Z0-9]{25,62}$/ // BTC
};
const valAddr = (net, v) => (RE[net] ? RE[net].test(v||'') : (v||'').length>=20);

let estText='—', order=null, poll=null;

function goto(id){ ['s1','s2','s3','s4'].forEach(x=>$('#'+x).classList.add('r')); $('#'+id).classList.remove('r'); }
function curSel(){ const [fs,fn]=$('#from').value.split(':'), [ts,tn]=$('#to').value.split(':'); return {fs,fn,ts,tn}; }

// 1) 견적
async function refreshEstimate(){
  const a=$('#amount').value||'0'; const {fs,ts}=curSel();
  try{ const r=await fetch(API.est(fs,ts,a)); const j=await r.json(); estText = j.estimated_amount ? `${Number(j.estimated_amount).toFixed(6)} ${ts}` : '—'; }
  catch{ estText='—'; }
  $('#est').textContent = estText;
}
['amount','from','to'].forEach(id=>$('#'+id).addEventListener('input',refreshEstimate));
['from','to'].forEach(id=>$('#'+id).addEventListener('change',refreshEstimate));
refreshEstimate();

// 2) Step1 -> Step2
$('#next1').onclick=()=>{
  $('#e1').style.display='none';
  const {fs,ts}=curSel();
  $('#sumSend').textContent = `${$('#amount').value} ${fs}`;
  $('#sumGet').textContent  = `≈ ${estText}`;
  goto('s2');
};

// 3) Step2: 실시간 검증 + 생성
function liveValidate(){
  const {fn,tn}=curSel();
  const rv=$('#recv').value.trim(), rf=$('#refund').value.trim();
  const recvOK = valAddr(tn, rv);
  const refOK  = valAddr(fn, rf);
  $('#recv').classList.toggle('invalid', rv && !recvOK);
  $('#refund').classList.toggle('invalid', rf && !refOK);
  return recvOK && refOK;
}
['recv','refund','from','to'].forEach(id=>$('#'+id).addEventListener('input',liveValidate));
['from','to'].forEach(id=>$('#'+id).addEventListener('change',()=>{ $('#recv').value=''; $('#refund').value=''; liveValidate(); }));

$('#next2').onclick=async ()=>{
  const ok = liveValidate();
  if(!ok){
    $('#e2').textContent='주소 형식을 다시 확인해 주세요. (수취=To 네트워크 / 리펀드=From 네트워크)';
    $('#e2').style.display='block';
    return;
  }
  $('#e2').style.display='none';
  const {fs,ts}=curSel();
  const body={ from:fs, to:ts, amount:$('#amount').value, rateType:'floating',
              address:$('#recv').value.trim(), refund:$('#refund').value.trim(), extraTo:'', extraRefund:'' };
  try{
    const r=await fetch(API.create,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const j=await r.json(); if(!r.ok || j.error) throw j;
    order=j;
    const dep=j.address||j.address_in||j.deposit||j.data?.address;
    const id=j.id||j.exchange_id||j.data?.id;
    $('#sendLabel').textContent = `${$('#amount').value} ${fs}`;
    $('#depAddr').textContent = dep||'—';
    $('#exId').textContent = id||'—';
    $('#qr').src = dep ? `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(dep)}` : '';
    $('#hashIn').textContent = '—';
    goto('s3');
    await pollOnce();
    if(poll) clearInterval(poll);
    poll=setInterval(pollOnce,10000);
  }catch(e){
    $('#e2').textContent='주문 생성 실패. 잠시 후 다시 시도하거나 입력값을 확인해 주세요.'; $('#e2').style.display='block';
  }
};

// 4) 상태 폴링: 3→4단계 전환/표시
function exp(sym, net, tx){
  if(!tx) return null; const s=sym.toUpperCase(), n=(net||'').toUpperCase();
  if(s==='BTC') return 'https://mempool.space/tx/'+tx;
  if(s==='ETH'||n==='ETH') return 'https://etherscan.io/tx/'+tx;
  if(n==='BSC') return 'https://bscscan.com/tx/'+tx;
  if(n==='MATIC') return 'https://polygonscan.com/tx/'+tx;
  if(s==='TRX'||n==='TRON') return 'https://tronscan.org/#/transaction/'+tx;
  return null;
}
async function pollOnce(){
  if(!order) return;
  const id=order.id||order.exchange_id||order.data?.id;
  const r=await fetch(API.status(id)); const j=await r.json(); const d=j.data||j;
  const st=(d.status||d.state||'waiting').toLowerCase();
  const txIn=d.txid||d.txid_in||d.deposit_txid; if(txIn) $('#hashIn').textContent = txIn.slice(0,10)+'...'+txIn.slice(-10);

  // 상태 라벨
  const label = st==='waiting'?'Pending deposit':(st==='confirming'?'Confirming':(st==='exchanging'?'Exchanging':(st==='sending'?'Sending':'Completed')));
  $('#s3state').innerHTML = `<span class="badge ${st==='confirming'?'warn':''}">${label}</span>`;

  if(['finished','refunded'].includes(st)){
    if(poll) clearInterval(poll);
    const {fs,ts}=curSel();
    const txOut=d.txid_out||d.withdrawal_txid||d.payout_txid;
    $('#cSend').textContent = `${$('#amount').value} ${fs}`;
    $('#cGet').textContent  = document.getElementById('est').textContent.replace('≈ ',''); // 근사값
    $('#cRecv').textContent = $('#recv').value.trim();
    $('#cIn').innerHTML  = txIn ? `<a href="${exp(fs, $('#from').value.split(':')[1], txIn)}" target="_blank" rel="noopener">${txIn.slice(0,10)}...${txIn.slice(-10)}</a>` : '—';
    $('#cOut').innerHTML = txOut ? `<a href="${exp(ts, $('#to').value.split(':')[1], txOut)}" target="_blank" rel="noopener">${txOut.slice(0,10)}...${txOut.slice(-10)}</a>` : '—';
    $('#cId').textContent = id || '—';
    goto('s4');
  }
}

$('#restart').onclick=()=>{ if(poll) clearInterval(poll); order=null; $('#recv').value=''; $('#refund').value=''; goto('s1'); refreshEstimate(); };
</script>
</body>
</html>
